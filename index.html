<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DPW Tool Scanner</title>
  <style>
    :root { --bg:#0b0b0b; --panel:#141414; --accent:#FF4F00; --accent2:#FFD300; --text:#f8f8f8; --muted:#9aa0a6; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, Arial, sans-serif; }
    header { position:sticky; top:0; border-bottom:2px solid var(--accent); background:var(--bg); }
    .wrap { max-width: 860px; margin:0 auto; padding:12px 16px; }
    .tag { display:inline-block; width:10px; height:32px; background:var(--accent); border-radius:6px; margin-right:8px;}
    h1 { font-size: 18px; margin:0; font-weight:700; letter-spacing:.3px; }
    .panel { background:var(--panel); border-radius:16px; padding:12px; box-shadow: 0 2px 10px rgba(0,0,0,.35); }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button, input[type="checkbox"] { font-size:14px; }
    button { padding:8px 12px; border-radius:12px; border:1px solid transparent; background:var(--accent); color:#111; font-weight:600; }
    button.alt { background:transparent; border-color:var(--accent2); color:var(--text); }
    button.warn { background:transparent; border-color:var(--accent); color:var(--text); }
    video { width:100%; aspect-ratio: 16/9; background:#000; border:1px solid var(--accent2); border-radius:12px; }
    .last { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:4px 6px; border:1px dashed var(--accent2); border-radius:8px; background:#111; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th { text-align:left; padding:8px; background:var(--accent); color:#111; }
    td { padding:8px; border-top:1px solid #222; }
    input.note { width:100%; background:transparent; color:var(--text); border:1px solid #2a2a2a; border-radius:8px; padding:6px; }
    footer { position:fixed; bottom:0; left:0; right:0; background:var(--panel); border-top:1px solid var(--accent); color:var(--muted); }
    .small { color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="tag"></div>
      <h1>DPW Tool Scanner</h1>
      <div style="margin-left:auto" class="small">barcode → spreadsheet</div>
    </div>
  </header>

  <main class="wrap" style="padding-bottom:96px">
    <div class="panel">
      <div class="row">
        <button id="startBtn">Start Camera</button>
        <button id="flipBtn" class="alt">Flip Camera</button>
        <label class="small"><input type="checkbox" id="dedupe" checked> De‑dupe</label>
        <label class="small"><input type="checkbox" id="beep" checked> Beep</label>
        <div style="margin-left:auto" class="small" id="status">Camera idle</div>
      </div>
      <div style="margin-top:8px"><video id="video" playsinline muted></video></div>
      <div class="small" style="margin-top:6px">Last: <span class="last" id="last"></span></div>
      <div id="error" class="small" style="margin-top:6px;color:var(--accent2)"></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="exportBtn" style="background:var(--accent2)">Export CSV</button>
      <button id="copyBtn" class="alt">Copy CSV</button>
      <button id="clearBtn" class="warn">Clear</button>
      <button id="stopBtn" class="warn">Stop</button>
    </div>

    <div class="panel" style="margin-top:12px">
      <table id="table">
        <thead>
          <tr><th>Time</th><th>Code</th><th>Note</th></tr>
        </thead>
        <tbody id="tbody">
          <tr id="emptyRow"><td colspan="3" class="small" style="text-align:center;color:var(--muted)">No scans yet.</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    <div class="wrap small">Built for Amanda • DPW — Safety Orange theme</div>
  </footer>

  <script type="module">
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const lastEl = document.getElementById('last');
    const errEl = document.getElementById('error');
    const tbody = document.getElementById('tbody');
    const emptyRow = document.getElementById('emptyRow');
    const dedupeEl = document.getElementById('dedupe');
    const beepEl = document.getElementById('beep');

    let ZX, reader, controls, stream = null, facing = 'environment';
    let seen = new Set();
    let items = [];

    function beep() {
      if (!beepEl.checked) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = 'square'; o.frequency.value = 880;
        g.gain.value = 0.05; o.start(); o.stop(ctx.currentTime + 0.12);
      } catch {}
    }

    function addRow(code) {
      if (dedupeEl.checked && (seen.has(code))) return;
      seen.add(code);
      const ts = new Date().toISOString();
      items.unshift({ ts, code, note: '' });
      if (emptyRow) emptyRow.remove();
      const tr = document.createElement('tr');
      tr.innerHTML = \`
        <td style="white-space:nowrap;font-family:ui-monospace;opacity:.8">\${new Date(ts).toLocaleString()}</td>
        <td style="font-family:ui-monospace">\${code}</td>
        <td><input class="note" placeholder="optional note (tool/location)"></td>\`;
      const input = tr.querySelector('input');
      input.addEventListener('input', e => { items.find(i=>i.ts===ts).note = e.target.value; });
      tbody.prepend(tr);
      lastEl.textContent = code;
      beep();
    }

    async function start() {
      try {
        errEl.textContent = '';
        if (!ZX) ZX = await import('https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm');
        if (controls) { controls.stop(); controls = null; }
        if (reader) { reader.reset(); reader = null; }

        const constraints = { video: { facingMode: { ideal: facing }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        reader = new ZX.BrowserMultiFormatReader();
        controls = await reader.decodeFromVideoElement(video, (result, err) => {
          if (result) addRow(String(result.getText()).trim());
        });
        statusEl.textContent = 'Scanning…';
      } catch (e) {
        errEl.textContent = '⚠ ' + (e?.message || e);
        statusEl.textContent = 'Error';
      }
    }

    function stop() {
      try { if (controls) controls.stop(); } catch {}
      try { if (reader) reader.reset(); } catch {}
      try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
      controls = null; reader = null; stream = null;
      statusEl.textContent = 'Stopped';
    }

    // Buttons
    document.getElementById('startBtn').onclick = start;
    document.getElementById('stopBtn').onclick = stop;
    document.getElementById('flipBtn').onclick = () => { facing = (facing === 'environment' ? 'user' : 'environment'); stop(); start(); };

    document.getElementById('clearBtn').onclick = () => {
      if (!confirm('Clear all scans?')) return;
      items = []; seen = new Set(); lastEl.textContent = '';
      tbody.innerHTML = ''; tbody.appendChild(emptyRow);
    };

    document.getElementById('copyBtn').onclick = async () => {
      const csv = toCSV(items.slice().reverse());
      try { await navigator.clipboard.writeText(csv); alert('CSV copied'); }
      catch (e) { alert('Copy failed: ' + (e?.message || e)); }
    };

    document.getElementById('exportBtn').onclick = () => {
      const csv = toCSV(items.slice().reverse());
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'dpw-scans-' + new Date().toISOString().slice(0,19) + '.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    function toCSV(rows) {
      const header = 'Timestamp,Code,Note\\n';
      const body = rows.map(r => [r.ts, esc(r.code), esc(r.note)].join(',')).join('\\n');
      return header + body + '\\n';
    }
    function esc(s){ if(s==null)s=''; s=String(s); return /[\",\\n]/.test(s)? '\"'+s.replaceAll('\"','\"\"')+'\"' : s; }
  </script>
</body>
</html>
