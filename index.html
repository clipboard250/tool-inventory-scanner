<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Man Pavilion • DPW Tool Scanner</title>
<style>
:root{--bg:#0b0b0b;--panel:#141414;--accent:#FF4F00;--accent2:#FFD300;--text:#f5f5f5;--muted:#9aa0a6}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
header{position:sticky;top:0;border-bottom:2px solid var(--accent);background:var(--bg)}
.wrap{max-width:860px;margin:0 auto;padding:12px 16px}
.tag{display:inline-block;width:10px;height:32px;background:var(--accent);border-radius:6px;margin-right:8px}
h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
.panel{background:var(--panel);border-radius:16px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.35)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
button{padding:10px 14px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#111;font-weight:700}
button.out{background:transparent;color:var(--text)}
.small{color:var(--muted);font-size:12px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
/* Camera fills box (no skinny vertical feed) */
.camwrap{position:relative;width:100%;height:54vh;max-height:440px;border:2px solid var(--accent);border-radius:12px;overflow:hidden;background:#000}
video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:rotate(0deg)}
/* Manual entry */
.manual{display:flex;gap:8px;margin-top:10px}
.manual input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2a;background:#0e0e0e;color:var(--text);font-size:18px}
.manual button{white-space:nowrap}
/* Table */
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:12px}
th{text-align:left;padding:8px;background:var(--accent);color:#111}
td{padding:8px;border-top:1px solid #222}
input.note{width:100%;background:transparent;color:var(--text);border:1px solid #2a2a2a;border-radius:8px;padding:6px}
</style></head><body>
<header><div class="wrap row"><div class="tag"></div><h1>Man Pavilion • DPW Tool Scanner</h1>
<div style="margin-left:auto" class="small">barcode → spreadsheet</div></div></header>

<main class="wrap" style="padding-bottom:96px">
  <div class="panel">
    <div class="row">
      <button id="startBtn">Start Camera</button>
      <button id="flipBtn" class="out">Flip Camera</button>
      <label class="small"><input type="checkbox" id="dedupe" checked> De‑dupe</label>
      <label class="small"><input type="checkbox" id="beep" checked> Beep</label>
      <div style="margin-left:auto" class="small" id="status">Camera idle</div>
    </div>

    <div class="camwrap"><video id="video" playsinline muted></video></div>

    <div class="small" style="margin-top:6px">Last: <span class="mono" id="last"></span></div>
    <div id="error" class="small" style="margin-top:6px;color:var(--accent2)"></div>

    <!-- Manual entry (for worn labels or no barcode) -->
    <div class="manual">
      <input id="manualCode" inputmode="numeric" pattern="[0-9\\-]*" placeholder="Type code (e.g., 554-10098)"/>
      <button id="addManual">Add</button>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <button id="exportBtn" style="background:var(--accent2);border-color:var(--accent2)">Export CSV</button>
    <button id="copyBtn" class="out" style="border-color:var(--accent2)">Copy CSV</button>
    <button id="clearBtn" class="out">Clear</button>
    <button id="stopBtn" class="out">Stop</button>
  </div>

  <div class="panel">
    <table><thead><tr><th>Time</th><th>Code</th><th>Note</th></tr></thead>
      <tbody id="tbody"><tr id="emptyRow"><td colspan="3" class="small" style="text-align:center">No scans yet.</td></tr></tbody>
    </table>
  </div>
</main>

<footer><div class="wrap small">Built for Amanda • Man Pavilion / DPW</div></footer>

<!-- iOS-friendly UMD build -->
<script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
<script>
const video=document.getElementById('video'), statusEl=document.getElementById('status'),
      lastEl=document.getElementById('last'), errEl=document.getElementById('error'),
      tbody=document.getElementById('tbody'), emptyRow=document.getElementById('emptyRow'),
      dedupeEl=document.getElementById('dedupe'), beepEl=document.getElementById('beep'),
      manualInput=document.getElementById('manualCode'), manualBtn=document.getElementById('addManual');

let reader=null, controls=null, stream=null, facing='environment', seen=new Set(), items=[];

function uiError(m){ errEl.textContent=m?('⚠ '+m):'' }
function beep(){ if(!beepEl.checked) return; try{const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='square';o.frequency.value=880;g.gain.value=0.05;o.start();o.stop(c.currentTime+0.12);}catch{} }
function addRow(code){ code=(code||'').trim(); if(!code) return;
  if(dedupeEl.checked && seen.has(code)) return; seen.add(code);
  const ts=new Date().toISOString(); items.unshift({ts,code,note:''});
  if(emptyRow) emptyRow.remove();
  const tr=document.createElement('tr'); tr.innerHTML=
   `<td class="mono" style="opacity:.8;white-space:nowrap">${new Date(ts).toLocaleString()}</td>
    <td class="mono">${code}</td>
    <td><input class="note" placeholder="optional note (tool/location)"></td>`;
  tr.querySelector('input').addEventListener('input',e=>{ items.find(i=>i.ts===ts).note=e.target.value });
  tbody.prepend(tr); lastEl.textContent=code; beep();
}

async function start(){
  uiError(''); statusEl.textContent='Starting…';
  try{
    if(controls){controls.stop();controls=null} if(reader){reader.reset();reader=null}
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:facing},width:{ideal:1920},height:{ideal:1080}},audio:false});
    video.srcObject=stream; await video.play();
    const hints=new Map();
    const formats=[ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39];
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
    reader=new ZXing.BrowserMultiFormatReader(hints);
    controls=await reader.decodeFromVideoElement(video,(res,err)=>{ if(res){ addRow(String(res.getText())) }});
    statusEl.textContent='Scanning…';
  }catch(e){ uiError(e?.message||String(e)); statusEl.textContent='Error' }
}
function stop(){ try{if(controls)controls.stop()}catch{} try{if(reader)reader.reset()}catch{} try{if(stream)stream.getTracks().forEach(t=>t.stop())}catch{} controls=null;reader=null;stream=null;statusEl.textContent='Stopped' }

document.getElementById('startBtn').onclick=start;
document.getElementById('stopBtn').onclick=stop;
document.getElementById('flipBtn').onclick=()=>{ facing=(facing==='environment'?'user':'environment'); stop(); start() };
document.getElementById('clearBtn').onclick=()=>{ if(!confirm('Clear all scans?'))return; items=[]; seen=new Set(); lastEl.textContent=''; tbody.innerHTML=''; tbody.appendChild(emptyRow) };
document.getElementById('copyBtn').onclick=async()=>{ const csv=toCSV(items.slice().reverse()); try{await navigator.clipboard.writeText(csv); alert('CSV copied')}catch(e){alert('Copy failed: '+(e?.message||e))} };
document.getElementById('exportBtn').onclick=()=>{ const csv=toCSV(items.slice().reverse()); const b=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='mp-dpw-scans-'+new Date().toISOString().slice(0,19)+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u) };
manualBtn.onclick=()=>{ addRow(manualInput.value); manualInput.value=''; manualInput.focus() };
manualInput.addEventListener('keyup',e=>{ if(e.key==='Enter') manualBtn.click() });

function toCSV(rows){ const header='Timestamp,Code,Note\n'; const body=rows.map(r=>[r.ts, esc(r.code), esc(r.note)].join(',')).join('\n'); return header+body+'\n' }
function esc(s){ if(s==null)s=''; s=String(s); return /[\",\\n]/.test(s)? '"'+s.replaceAll('"','""')+'"' : s }
</script></body></html>
