<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Man Pavilion Tool Logger (subset of DPW)</title>
<style>
:root{--bg:#0b0b0b;--panel:#141414;--accent:#FF4F00;--accent2:#FFD300;--text:#f5f5f5;--muted:#9aa0a6}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
header{position:sticky;top:0;border-bottom:2px solid var(--accent);background:var(--bg)}
.wrap{max-width:860px;margin:0 auto;padding:12px 16px}
.tag{display:inline-block;width:10px;height:32px;background:var(--accent);border-radius:6px;margin-right:8px}
h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
.small{color:var(--muted);font-size:12px}
.panel{background:var(--panel);border-radius:16px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.35)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
button{padding:12px 14px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#111;font-weight:700}
button.ghost{background:transparent;color:var(--text)}
button.warn{background:transparent;border-color:var(--accent);color:var(--text)}
input,select{border:1px solid #2a2a2a;border-radius:12px;background:#0e0e0e;color:var(--text)}
input::placeholder{color:#777}
input.big{font-size:20px;padding:14px}
input.med{font-size:16px;padding:12px}
label{font-size:13px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.camwrap{position:relative;width:100%;height:48vh;max-height:420px;border:2px solid var(--accent);border-radius:12px;overflow:hidden;background:#000}
video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.seg{display:flex;gap:6px}
.seg button{flex:1;padding:10px;border-radius:999px;border:1px solid #2a2a2a;background:#111;color:#ddd;font-weight:700}
.seg button.active{background:var(--accent2);border-color:var(--accent2);color:#111}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:12px}
th{text-align:left;padding:8px;background:var(--accent);color:#111}
td{padding:8px;border-top:1px solid #222}
input.note{width:100%;background:transparent;color:var(--text);border:1px solid #2a2a2a;border-radius:8px;padding:6px}
footer{border-top:1px solid var(--accent);background:var(--panel)}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#222;border:1px solid #333}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="tag"></div>
    <h1>Man Pavilion Tool Logger (DPW)</h1>
    <div style="margin-left:auto" class="small">number → spreadsheet • mobile first</div>
  </div>
</header>

<main class="wrap" style="padding-bottom:96px">
  <!-- FAST ENTRY -->
  <div class="panel">
    <div class="small" style="margin-bottom:6px">Step 1: **Scan or type the code** • Step 2: name the item • Step 3: pick a status • Step 4: Add Row</div>
    <div class="row">
      <input id="code" class="big mono" inputmode="numeric" pattern="[0-9\-]*" placeholder="Code (e.g., 554-10098)" style="flex:1" autofocus />
      <button id="scanBtn" class="ghost" style="border-color:var(--accent2)">Scan Barcode</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="item" class="med" placeholder="What is it? (e.g., M18 5.0Ah battery)" style="flex:1"/>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="seg" id="statusSeg" style="flex:1">
        <button data-v="ADD" class="active">Add</button>
        <button data-v="CHECK-OUT">Check‑out</button>
        <button data-v="RETURN">Return</button>
        <button data-v="BROKEN">Broken</button>
        <button data-v="LOST">Lost</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <label><input id="autoAdd" type="checkbox" /> Auto‑add on scan</label>
      <div class="small" id="status" style="margin-left:auto">Ready</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="addBtn">Add Row</button>
      <button id="clearInputs" class="ghost">Clear fields</button>
    </div>

    <!-- CAMERA (only when scanning) -->
    <div id="camBlock" style="display:none; margin-top:10px">
      <div class="camwrap"><video id="video" playsinline muted></video></div>
      <div class="row" style="margin-top:8px">
        <button id="flipBtn" class="ghost">Flip</button>
        <button id="torchBtn" class="ghost">Flash</button>
        <span class="badge" id="modeBadge">Barcode mode</span>
        <button id="stopBtn" class="warn" style="margin-left:auto">Stop Camera</button>
      </div>
      <div id="error" class="small" style="margin-top:6px;color:var(--accent2)"></div>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="row" style="margin-top:12px">
    <button id="exportBtn" style="background:var(--accent2);border-color:var(--accent2)">Export CSV</button>
    <button id="copyBtn" class="ghost" style="border-color:var(--accent2)">Copy CSV</button>
    <label class="small"><input id="dedupe" type="checkbox" checked/> De‑dupe codes</label>
  </div>

  <!-- TABLE -->
  <div class="panel">
    <table>
      <thead><tr><th>Time</th><th>Code</th><th>Item</th><th>Status</th><th>Note</th></tr></thead>
      <tbody id="tbody"><tr id="emptyRow"><td colspan="5" class="small" style="text-align:center">No rows yet.</td></tr></tbody>
    </table>
  </div>
</main>

<footer><div class="wrap small">Man Pavilion • subset of DPW</div></footer>

<!-- ZXing for barcode (no OCR) -->
<script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
<script>
const codeEl = document.getElementById('code');
const itemEl = document.getElementById('item');
const addBtn = document.getElementById('addBtn');
const clearInputsBtn = document.getElementById('clearInputs');
const tbody = document.getElementById('tbody');
const emptyRow = document.getElementById('emptyRow');
const statusEl = document.getElementById('status');
const dedupeEl = document.getElementById('dedupe');
const autoAddEl = document.getElementById('autoAdd');
const seg = document.getElementById('statusSeg');
let currentStatus = 'ADD';

// status buttons
[...seg.querySelectorAll('button')].forEach(btn=>{
  btn.onclick=()=>{
    [...seg.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); currentStatus = btn.dataset.v;
  };
});

function beep(){ try{const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='square';o.frequency.value=880;g.gain.value=0.06;o.start();o.stop(c.currentTime+0.1);}catch{} }

let items=[], seen=new Set();

// ADD ROW
function addRow(fromScan=false){
  const code = (codeEl.value||'').trim();
  if(!code){ flashField(codeEl); return; }
  if(dedupeEl.checked && seen.has(code) && fromScan){ // prevent rapid repeats from camera
    return;
  }
  const item = (itemEl.value||'').trim();
  const ts = new Date().toISOString();
  items.unshift({ts, code, item, status: currentStatus, note:''});
  seen.add(code);
  if(emptyRow) emptyRow.remove();
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="mono" style="opacity:.8;white-space:nowrap">${new Date(ts).toLocaleString()}</td>
    <td class="mono">${code}</td>
    <td>${escapeHtml(item)}</td>
    <td class="mono">${currentStatus}</td>
    <td><input class="note" placeholder="optional note"></td>`;
  tr.querySelector('input').addEventListener('input', e => {
    const r = items.find(x=>x.ts===ts); if(r) r.note = e.target.value;
  });
  tbody.prepend(tr);
  beep();
  // reset for next
  if(!fromScan){ codeEl.value=''; }
  itemEl.value='';
  codeEl.focus();
}
addBtn.onclick = ()=>addRow(false);
clearInputsBtn.onclick = ()=>{ codeEl.value=''; itemEl.value=''; codeEl.focus(); };

// EXPORT/COPY
document.getElementById('exportBtn').onclick=()=>{
  const csv = toCSV(items.slice().reverse());
  const b = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const u = URL.createObjectURL(b);
  const a = document.createElement('a');
  a.href = u; a.download = 'man-pavilion-log-'+new Date().toISOString().slice(0,19)+'.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
};
document.getElementById('copyBtn').onclick=async()=>{
  try{ await navigator.clipboard.writeText(toCSV(items.slice().reverse())); alert('CSV copied'); }
  catch(e){ alert('Copy failed: '+(e?.message||e)); }
};
function toCSV(rows){
  const header = 'Timestamp,Code,Item,Status,Note\n';
  const body = rows.map(r=>[r.ts, esc(r.code), esc(r.item), esc(r.status), esc(r.note)].join(',')).join('\n');
  return header + body + '\n';
}
function esc(s){ if(s==null)s=''; s=String(s); return /[",\n]/.test(s)? '"'+s.replaceAll('"','""')+'"' : s; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function flashField(el){ const old=el.style.borderColor; el.style.borderColor='#ff6'; setTimeout(()=>el.style.borderColor=old,600); }

// ================= BARCODE SCAN =================
const scanBtn = document.getElementById('scanBtn');
const camBlock = document.getElementById('camBlock');
const video = document.getElementById('video');
const flipBtn = document.getElementById('flipBtn');
const torchBtn = document.getElementById('torchBtn');
const stopBtn = document.getElementById('stopBtn');
const errEl = document.getElementById('error');
const modeBadge = document.getElementById('modeBadge');

let reader=null, controls=null, stream=null, facing='environment';

scanBtn.onclick = async ()=>{ await startCamera(); };
flipBtn.onclick = async ()=>{ facing = (facing==='environment'?'user':'environment'); await startCamera(); };
stopBtn.onclick = ()=> stopCamera();

async function startCamera(){
  errEl.textContent=''; modeBadge.textContent='Barcode mode';
  camBlock.style.display='block';
  statusEl.textContent='Starting camera…';
  try{
    if(controls){controls.stop();controls=null}
    if(reader){reader.reset();reader=null}
    if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null}

    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ideal:facing}, width:{ideal:1920}, height:{ideal:1080} }, audio:false
    });
    video.srcObject = stream; await video.play();

    // Torch toggle support
    torchBtn.onclick = async ()=>{
      try{
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities?.();
        if(caps && caps.torch){
          await track.applyConstraints({ advanced:[{ torch: !track.getConstraints().advanced?.[0]?.torch }] });
        }else{ alert('Flash not supported on this device'); }
      }catch(e){ alert('Flash error: '+(e?.message||e)); }
    };

    const hints = new Map();
    const fmts = [ ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39, ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8 ];
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, fmts);
    reader = new ZXing.BrowserMultiFormatReader(hints);

    controls = await reader.decodeFromVideoElement(video, (res, err) => {
      if(res){
        const text = String(res.getText()).trim();
        codeEl.value = text;
        statusEl.textContent = 'Scanned: '+text;
        if(autoAddEl.checked){ addRow(true); }
        beep();
      }
    });
    statusEl.textContent='Scanning… aim the sticker so the whole barcode is visible.';
  }catch(e){
    errEl.textContent = '⚠ ' + (e?.message || e);
    statusEl.textContent='Camera error';
  }
}
function stopCamera(){
  try{ if(controls) controls.stop(); }catch{}
  try{ if(reader) reader.reset(); }catch{}
  try{ if(stream) stream.getTracks().forEach(t=>t.stop()); }catch{}
  controls=null; reader=null; stream=null; statusEl.textContent='Camera stopped';
  camBlock.style.display='none';
}
// Enter key = Add Row
codeEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addRow(false); }});
itemEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addRow(false); }});
</script>
</body>
</html>
